<!DOCTYPE html>
<html lang="hu" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fejlett Képkonvertáló és -átméretező</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .drag-over { border-color: #3b82f6; background-color: #eff6ff; }
    .dark .drag-over { border-color: #60a5fa; background-color: #1e293b; }
    .spinner { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .aspect-ratio-lock.locked path:nth-child(1) { d: path('M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'); }
    .aspect-ratio-lock:not(.locked) path:nth-child(2) { d: path('M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'); }
  </style>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

  <button id="themeToggle" class="fixed top-4 right-4 z-50 p-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-900">
    <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z" /></svg>
    <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
  </button>

  <header class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">Fejlett Képkonvertáló</h1>
      <p class="mt-1 text-slate-600 dark:text-slate-400">Konvertálj és méretezz át képeket professzionális minőségben.</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
      
      <!-- Bal oldali vezérlőpanel -->
      <aside class="md:col-span-4 lg:col-span-3">
        <div class="sticky top-24 space-y-6">
          <!-- Feltöltés -->
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg">
            <div class="p-5 border-b border-slate-200 dark:border-slate-700">
              <h2 class="text-xl font-semibold">1. Képek hozzáadása</h2>
            </div>
            <div id="uploadArea" tabindex="0" role="button" class="p-6 text-center border-2 border-dashed border-slate-300 dark:border-slate-600 m-5 rounded-lg cursor-pointer hover:border-blue-500 dark:hover:border-blue-400 transition-colors">
              <svg class="mx-auto h-10 w-10 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
              <p class="mt-2 font-semibold text-slate-700 dark:text-slate-300">Kattints vagy húzd ide</p>
              <input type="file" id="fileInput" class="hidden" multiple accept="image/png, image/jpeg, image/webp, image/gif">
            </div>
          </div>

          <!-- Globális beállítások -->
          <div id="globalControls" class="bg-white dark:bg-slate-800 rounded-xl shadow-lg hidden">
            <div class="p-5 border-b border-slate-200 dark:border-slate-700">
              <h2 class="text-xl font-semibold">2. Csoportos Műveletek</h2>
            </div>
            <div class="p-5 space-y-4">
              <div>
                <label for="globalFormat" class="block text-sm font-medium mb-1">Formátum</label>
                <select id="globalFormat" class="w-full py-2 px-3 bg-slate-50 dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500">
                  <option value="png">PNG</option>
                  <option value="jpg">JPG</option>
                  <option value="webp">WebP</option>
                </select>
              </div>
              <div id="globalQualityWrapper">
                <label for="globalQuality" class="block text-sm font-medium mb-1">Minőség: <span id="globalQualityValue">90</span>%</label>
                <input type="range" id="globalQuality" min="1" max="100" value="90" class="w-full h-2 bg-slate-200 dark:bg-slate-600 rounded-lg appearance-none cursor-pointer">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Átméretezés (opcionális)</label>
                <div class="flex gap-2">
                  <input type="number" id="globalWidth" placeholder="Szélesség" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500">
                  <input type="number" id="globalHeight" placeholder="Magasság" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500">
                </div>
              </div>
              <div class="pt-2 space-y-3">
                 <button id="bulkDownloadBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                  Összes letöltése ZIP-ként
                </button>
                <button id="clearAllBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 font-semibold text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900 transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  Minden törlése
                </button>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Jobb oldali képrács -->
      <div id="imageGrid" class="md:col-span-8 lg:col-span-9 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        <!-- A képkártyák ide kerülnek -->
      </div>
    </div>
  </main>
  
  <div id="loadingOverlay" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex-col items-center justify-center hidden"><div class="spinner w-12 h-12 rounded-full border-4 border-slate-400/50"></div><p id="loadingText" class="mt-4 text-white font-semibold text-lg">Feldolgozás...</p></div>
  <div id="alertContainer" class="fixed top-24 right-4 z-[90] w-full max-w-xs space-y-3"></div>
  <div id="confirmModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden"><div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md p-6"><h3 id="confirmModalTitle" class="text-lg font-semibold mb-2">Megerősítés</h3><p id="confirmModalText" class="text-slate-600 dark:text-slate-400 mb-6">Biztosan folytatni szeretnéd?</p><div class="flex justify-end gap-3"><button id="confirmCancelBtn" class="px-4 py-2 font-semibold text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition">Mégse</button><button id="confirmOkBtn" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Törlés</button></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pica@9.0.1/dist/pica.min.js"></script>
  
  <script>
    'use strict';

    class ImageConverterApp {
      /**
       * @typedef {object} ImageState
       * @property {string} id - Egyedi azonosító
       * @property {File} file - Az eredeti fájl objektum
       * @property {string} originalUrl - Az eredeti kép data URL-je
       * @property {number} originalWidth - Eredeti szélesség
       * @property {number} originalHeight - Eredeti magasság
       * @property {string | null} processedUrl - A feldolgozott kép data URL-je
       * @property {number | null} processedWidth - Feldolgozott szélesség
       * @property {number | null} processedHeight - Feldolgozott magasság
       */

      /** @type {ImageState[]} */
      images = [];
      isProcessing = false;
      confirmCallback = null;
      pica = window.pica();

      CONFIG = {
        SUPPORTED_FORMATS: ['png', 'jpg', 'webp'],
        DEFAULT_QUALITY: 90,
      };

      constructor() {
        this.initializeElements();
        this.attachEventListeners();
        this.initializeTheme();
      }

      initializeElements() {
        this.elements = {
          fileInput: document.getElementById('fileInput'),
          uploadArea: document.getElementById('uploadArea'),
          imageGrid: document.getElementById('imageGrid'),
          globalControls: document.getElementById('globalControls'),
          globalFormat: document.getElementById('globalFormat'),
          globalQuality: document.getElementById('globalQuality'),
          globalQualityValue: document.getElementById('globalQualityValue'),
          globalQualityWrapper: document.getElementById('globalQualityWrapper'),
          globalWidth: document.getElementById('globalWidth'),
          globalHeight: document.getElementById('globalHeight'),
          bulkDownloadBtn: document.getElementById('bulkDownloadBtn'),
          clearAllBtn: document.getElementById('clearAllBtn'),
          // ... (többi elem)
          themeToggle: document.getElementById('themeToggle'), themeIconSun: document.getElementById('themeIconSun'), themeIconMoon: document.getElementById('themeIconMoon'), loadingOverlay: document.getElementById('loadingOverlay'), loadingText: document.getElementById('loadingText'), alertContainer: document.getElementById('alertContainer'), confirmModal: document.getElementById('confirmModal'), confirmModalTitle: document.getElementById('confirmModalTitle'), confirmModalText: document.getElementById('confirmModalText'), confirmOkBtn: document.getElementById('confirmOkBtn'), confirmCancelBtn: document.getElementById('confirmCancelBtn'),
        };
      }

      attachEventListeners() {
        const { uploadArea, fileInput, themeToggle, imageGrid, globalQuality, globalFormat, clearAllBtn, bulkDownloadBtn, confirmCancelBtn, confirmOkBtn } = this.elements;

        fileInput.addEventListener('change', e => this.handleFileSelect(e.target.files));
        uploadArea.addEventListener('click', () => fileInput.click());
        ['dragenter','dragover','dragleave','drop'].forEach(eName => uploadArea.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter','dragover'].forEach(eName => uploadArea.addEventListener(eName, () => uploadArea.classList.add('drag-over')));
        ['dragleave','drop'].forEach(eName => uploadArea.addEventListener(eName, () => uploadArea.classList.remove('drag-over')));
        uploadArea.addEventListener('drop', e => this.handleFileSelect(e.dataTransfer.files));
        
        themeToggle.addEventListener('click', () => this.toggleTheme());
        imageGrid.addEventListener('click', e => this.handleImageGridClick(e));
        imageGrid.addEventListener('input', e => this.handleImageCardInput(e));
        
        globalQuality.addEventListener('input', () => this.elements.globalQualityValue.textContent = this.elements.globalQuality.value);
        globalFormat.addEventListener('change', () => this.elements.globalQualityWrapper.style.display = this.elements.globalFormat.value === 'png' ? 'none' : 'block');
        
        clearAllBtn.addEventListener('click', () => this.handleClearAll());
        bulkDownloadBtn.addEventListener('click', () => this.handleBulkDownload());

        confirmCancelBtn.addEventListener('click', () => this.hideConfirm());
        confirmOkBtn.addEventListener('click', () => { if (this.confirmCallback) this.confirmCallback(); this.hideConfirm(); });
      }

      // TÉMA ÉS UI KEZELÉS (változatlan)
      initializeTheme() { this.setTheme(localStorage.getItem('theme') || 'system'); }
      setTheme(theme) { localStorage.setItem('theme', theme); if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); this.elements.themeIconSun.classList.remove('hidden'); this.elements.themeIconMoon.classList.add('hidden'); } else { document.documentElement.classList.remove('dark'); this.elements.themeIconSun.classList.add('hidden'); this.elements.themeIconMoon.classList.remove('hidden'); } }
      toggleTheme() { this.setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'); }
      showLoading(message = 'Feldolgozás...') { this.elements.loadingText.textContent = message; this.elements.loadingOverlay.classList.remove('hidden'); this.elements.loadingOverlay.classList.add('flex'); this.isProcessing = true; }
      hideLoading() { this.elements.loadingOverlay.classList.add('hidden'); this.elements.loadingOverlay.classList.remove('flex'); this.isProcessing = false; }
      showAlert(message, type = 'error') { const C = { s: {b:'bg-green-100 dark:bg-green-900',t:'text-green-800 dark:text-green-200',d:'border-green-400'}, e: {b:'bg-red-100 dark:bg-red-900',t:'text-red-800 dark:text-red-200',d:'border-red-400'}, w: {b:'bg-yellow-100 dark:bg-yellow-900',t:'text-yellow-800 dark:text-yellow-200',d:'border-yellow-400'}};const a = document.createElement('div');a.className = `p-4 rounded-lg border-l-4 shadow-md transition-all duration-300 transform translate-x-full ${C[type[0]].b} ${C[type[0]].t} ${C[type[0]].d}`;a.textContent=message;this.elements.alertContainer.appendChild(a);requestAnimationFrame(()=>a.classList.remove('translate-x-full'));setTimeout(()=>{a.classList.add('opacity-0','translate-x-full');a.addEventListener('transitionend',()=>a.remove());},5000); }
      showConfirm({ title = 'Megerősítés', text, okText = 'Rendben', okClass = 'bg-blue-600', onConfirm }) { this.elements.confirmModalTitle.textContent = title; this.elements.confirmModalText.textContent = text; this.elements.confirmOkBtn.textContent = okText; this.elements.confirmOkBtn.className = `px-4 py-2 font-semibold text-white rounded-lg transition ${okClass}`; this.confirmCallback = onConfirm; this.elements.confirmModal.classList.remove('hidden'); }
      hideConfirm() { this.elements.confirmModal.classList.add('hidden'); this.confirmCallback = null; }

      // FÁJL- ÉS ADATKEZELÉS
      async handleFileSelect(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        if (!imageFiles.length) return;
        this.showLoading(`Képek betöltése: ${imageFiles.length} fájl...`);
        try {
          const newImages = await Promise.all(imageFiles.map(f => this.createImageData(f)));
          this.images.push(...newImages);
          this.showAlert(`${newImages.length} kép sikeresen betöltve.`, 'success');
        } catch (error) {
          console.error('Hiba a fájlok feldolgozása közben:', error);
          this.showAlert('Hiba történt a fájlok betöltésekor.', 'error');
        } finally {
          this.render();
          this.hideLoading();
        }
      }

      /** @param {File} file */
      createImageData(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => {
            const img = new Image();
            img.onload = () => resolve({
              id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              file,
              originalUrl: e.target.result,
              originalWidth: img.width,
              originalHeight: img.height,
              processedUrl: null,
              processedWidth: null,
              processedHeight: null,
            });
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // ESEMÉNYKEZELŐK
      handleImageGridClick(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const imageId = button.dataset.imageId;
        const image = this.images.find(img => img.id === imageId);
        if (!image) return;

        switch(button.dataset.action) {
          case 'process': this.handleProcessImage(image.id); break;
          case 'download': this.handleDownloadImage(image.id, button.dataset.format); break;
          case 'reset': this.handleResetImage(image.id); break;
          case 'remove': this.handleRemoveImage(image.id); break;
          case 'toggle-aspect': button.classList.toggle('locked'); break;
        }
      }

      handleImageCardInput(e) {
          const input = e.target.closest('input[data-image-id]');
          if (!input) return;
          const image = this.images.find(img => img.id === input.dataset.imageId);
          const card = document.getElementById(image.id);
          const lockBtn = card.querySelector('[data-action="toggle-aspect"]');

          if (!image || !lockBtn.classList.contains('locked')) return;

          const isWidthInput = input.id.startsWith('width');
          let value = parseInt(input.value, 10);
          if (isNaN(value) || value < 1) return;
          
          const otherInput = isWidthInput 
              ? card.querySelector('input[id^=height]') 
              : card.querySelector('input[id^=width]');
          const ratio = image.originalWidth / image.originalHeight;
          otherInput.value = Math.round(isWidthInput ? value / ratio : value * ratio);
      }
      
      handleClearAll() {
        if (!this.images.length) return;
        this.showConfirm({
          text: `Biztosan törölni szeretnéd mind a(z) ${this.images.length} képet?`,
          okText: 'Igen, törlés', okClass: 'bg-red-600 hover:bg-red-700',
          onConfirm: () => {
            this.images = [];
            this.elements.fileInput.value = '';
            this.render();
            this.showAlert('Minden törölve.', 'success');
          }
        });
      }

      // KÉPFELDOLGOZÓ LOGIKA
      /**
       * Egyetlen kép feldolgozása a kártyáján lévő beállítások alapján.
       * @param {string} imageId A kép azonosítója
       */
      async handleProcessImage(imageId) {
        if (this.isProcessing) return;
        const image = this.images.find(img => img.id === imageId);
        const card = document.getElementById(image.id);
        const width = parseInt(card.querySelector('input[id^=width]').value, 10);
        const height = parseInt(card.querySelector('input[id^=height]').value, 10);

        if (!width || !height || width <= 0 || height <= 0) {
          return this.showAlert('Adjon meg érvényes méreteket.', 'warning');
        }

        this.showLoading('Kép átméretezése...');
        try {
          const processedUrl = await this.picaResize(image.originalUrl, width, height);
          image.processedUrl = processedUrl;
          image.processedWidth = width;
          image.processedHeight = height;
          this.updateCardUI(image);
          this.showAlert('Kép sikeresen átméretezve!', 'success');
        } catch (error) {
          console.error('Átméretezési hiba:', error);
          this.showAlert('Nem sikerült átméretezni a képet.', 'error');
        } finally {
          this.hideLoading();
        }
      }

      /**
       * Egyetlen kép letöltése.
       * @param {string} imageId A kép azonosítója
       * @param {string} format A célformátum (pl. 'jpg')
       */
      async handleDownloadImage(imageId, format) {
        if (this.isProcessing) return;
        const image = this.images.find(img => img.id === imageId);
        this.showLoading(`Konvertálás és letöltés (${format.toUpperCase()})...`);
        try {
          const sourceUrl = image.processedUrl || image.originalUrl;
          const quality = document.getElementById(`quality-${image.id}`)?.value || this.CONFIG.DEFAULT_QUALITY;
          const blob = await this.urlToBlob(sourceUrl, format, quality);

          const baseName = image.file.name.replace(/\.[^/.]+$/, '');
          const dim = image.processedUrl ? `_${image.processedWidth}x${image.processedHeight}` : `_${image.originalWidth}x${image.originalHeight}`;
          const ext = `.${format}`;
          
          saveAs(blob, `${baseName}${dim}${ext}`);
        } catch (error) {
          console.error("Letöltési hiba:", error);
          this.showAlert('Nem sikerült letölteni a képet.', 'error');
        } finally {
          this.hideLoading();
        }
      }
      
      /** Egy kép visszaállítása az eredeti állapotába. */
      handleResetImage(imageId) {
        const image = this.images.find(img => img.id === imageId);
        image.processedUrl = null;
        image.processedWidth = null;
        image.processedHeight = null;
        this.updateCardUI(image);
        this.showAlert('Kép visszaállítva.', 'success');
      }

      /** Egy kép eltávolítása a listából. */
      handleRemoveImage(imageId) {
        const image = this.images.find(img => img.id === imageId);
        this.showConfirm({
          text: `Biztosan törölni szeretnéd a(z) "${image.file.name}" nevű képet?`,
          okText: 'Törlés', okClass: 'bg-red-600 hover:bg-red-700',
          onConfirm: () => {
            this.images = this.images.filter(img => img.id !== imageId);
            this.render();
            this.showAlert('Kép törölve.', 'success');
          }
        });
      }

      /**
       * Az összes kép letöltése ZIP-ben a globális beállítások alapján.
       */
      async handleBulkDownload() {
        if (this.isProcessing || !this.images.length) return;

        const { globalFormat, globalQuality, globalWidth, globalHeight } = this.elements;
        const format = globalFormat.value;
        const quality = globalQuality.value;
        const width = parseInt(globalWidth.value, 10) || null;
        const height = parseInt(globalHeight.value, 10) || null;
        
        this.showLoading(`Csoportos feldolgozás (${this.images.length} kép)...`);
        
        try {
            const zip = new JSZip();
            for (const image of this.images) {
                let targetUrl = image.originalUrl;
                let targetWidth = image.originalWidth;
                let targetHeight = image.originalHeight;
                
                // Átméretezés, ha meg van adva
                if (width || height) {
                    const ratio = image.originalWidth / image.originalHeight;
                    targetWidth = width || Math.round(height * ratio);
                    targetHeight = height || Math.round(width / ratio);
                    targetUrl = await this.picaResize(image.originalUrl, targetWidth, targetHeight);
                }

                const blob = await this.urlToBlob(targetUrl, format, quality);
                const baseName = image.file.name.replace(/\.[^/.]+$/, '');
                zip.file(`${baseName}_${targetWidth}x${targetHeight}.${format}`, blob);
            }
            
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            saveAs(zipBlob, `kepek_${format}.zip`);
        } catch (error) {
            console.error('Csoportos letöltési hiba:', error);
            this.showAlert('Hiba történt a ZIP készítése közben.', 'error');
        } finally {
            this.hideLoading();
        }
      }

      // KÉPFELDOLGOZÓ SEGÉDFÜGGVÉNYEK
      /**
       * Kép átméretezése a Pica könyvtárral.
       * @param {string} imageUrl A kép data URL-je
       * @param {number} width A cél szélesség
       * @param {number} height A cél magasság
       * @returns {Promise<string>} Az átméretezett kép data URL-je
       */
      picaResize(imageUrl, width, height) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = async () => {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            try {
              await this.pica.resize(img, canvas, { alpha: true });
              resolve(canvas.toDataURL('image/png')); // Pica mindig PNG-t ad vissza
            } catch (error) { reject(error); }
          };
          img.onerror = () => reject(new Error('Kép betöltése sikertelen'));
          img.src = imageUrl;
        });
      }

      /**
       * Data URL konvertálása Blob objektummá a kívánt formátumban és minőségben.
       * @param {string} imageUrl A kép data URL-je
       * @param {string} format A célformátum ('jpg', 'png', 'webp')
       * @param {number} quality A minőség (1-100)
       * @returns {Promise<Blob>} A konvertált Blob
       */
      urlToBlob(imageUrl, format, quality) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            
            // JPG hátterének kitöltése
            if (format === 'jpg') {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            ctx.drawImage(img, 0, 0);

            const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
            canvas.toBlob(blob => {
              if (blob) resolve(blob);
              else reject(new Error('Blob konverzió sikertelen.'));
            }, mimeType, quality / 100);
          };
          img.onerror = () => reject(new Error('Kép konvertálása sikertelen'));
          img.src = imageUrl;
        });
      }

      // RENDERELÉS
      formatFileSize(bytes) { if (bytes === 0) return '0 B'; const k = 1024; const s = ['B', 'KB', 'MB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + s[i]; }
      
      render() {
        this.elements.imageGrid.innerHTML = this.images.map(image => this.createImageCardHTML(image)).join('');
        const hasImages = this.images.length > 0;
        this.elements.globalControls.classList.toggle('hidden', !hasImages);
      }

      updateCardUI(image) {
        const card = document.getElementById(image.id);
        if (!card) return;
        
        const displayUrl = image.processedUrl || image.originalUrl;
        const displayWidth = image.processedWidth || image.originalWidth;
        const displayHeight = image.processedHeight || image.originalHeight;
        
        card.querySelector('img').src = displayUrl;
        card.querySelector('.status-text').innerHTML = image.processedUrl
            ? `<p class="font-semibold text-green-600 dark:text-green-400">Feldolgozva: ${displayWidth}×${displayHeight}px</p>`
            : '<p>Eredeti állapot</p>';
        card.querySelector('[data-action="reset"]').classList.toggle('hidden', !image.processedUrl);
      }

      createImageCardHTML(image) {
        const displayUrl = image.processedUrl || image.originalUrl;
        const displayWidth = image.processedWidth || image.originalWidth;
        const displayHeight = image.processedHeight || image.originalHeight;

        return `
          <div id="${image.id}" class="bg-white dark:bg-slate-800 rounded-xl shadow-lg flex flex-col transition-all duration-300 animate-fade-in">
            <div class="p-4 flex-grow">
              <div class="relative group">
                <div class="aspect-video mb-3 rounded-lg overflow-hidden bg-slate-200 dark:bg-slate-700 ring-1 ring-slate-900/5">
                  <img src="${displayUrl}" alt="${image.file.name}" loading="lazy" class="w-full h-full object-contain">
                </div>
                <button data-action="remove" data-image-id="${image.id}" class="absolute top-2 right-2 p-1.5 bg-red-600/80 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
              </div>
              <h3 class="font-semibold truncate" title="${image.file.name}">${image.file.name}</h3>
              <div class="text-sm text-slate-500 dark:text-slate-400 space-y-1 mt-1 mb-4">
                <p>Eredeti: ${image.originalWidth}×${image.originalHeight}px (${this.formatFileSize(image.file.size)})</p>
                <div class="status-text">${image.processedUrl ? `<p class="font-semibold text-green-600 dark:text-green-400">Feldolgozva: ${displayWidth}×${displayHeight}px</p>` : '<p>Eredeti állapot</p>'}</div>
              </div>
              
              <div class="space-y-3">
                <div class="flex items-center gap-2">
                  <input type="number" id="width-${image.id}" data-image-id="${image.id}" value="${image.originalWidth}" class="w-full px-3 py-2 text-sm bg-slate-50 dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500" placeholder="Szélesség">
                  <button data-action="toggle-aspect" data-image-id="${image.id}" class="aspect-ratio-lock locked p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><path d="M8 12h8"></path></svg>
                    <svg class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"></path></svg>
                  </button>
                  <input type="number" id="height-${image.id}" data-image-id="${image.id}" value="${image.originalHeight}" class="w-full px-3 py-2 text-sm bg-slate-50 dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500" placeholder="Magasság">
                </div>
                <div class="flex items-center gap-2">
                  <button data-action="process" data-image-id="${image.id}" class="flex-1 px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition">Alkalmaz</button>
                  <button data-action="reset" data-image-id="${image.id}" class="p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 ${!image.processedUrl ? 'hidden' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.546A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.546-1.276z" clip-rule="evenodd" /></svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-700">
              <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-2">Letöltés más formátumban:</label>
              <div class="grid grid-cols-3 gap-2">
                ${this.CONFIG.SUPPORTED_FORMATS.map(format => `
                  <button data-action="download" data-format="${format}" data-image-id="${image.id}" class="px-2 py-1.5 text-xs font-semibold text-white bg-teal-600 rounded-md hover:bg-teal-700 transition">${format.toUpperCase()}</button>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }
    }
    document.addEventListener('DOMContentLoaded', () => { new ImageConverterApp(); });
  </script>
</body>
</html>